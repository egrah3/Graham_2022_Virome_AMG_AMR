
--- 
title: "My Document" 
output: html_document: 
fig_width: 6 
fig_height: 4 
--- 
```{r}
core_SC_rm <- merge_phyloseq(core_SC_P01_rm, core_SC_P02_rm, core_SC_P03_rm, core_SC_P04_rm, core_SC_P05_rm, core_SC_P06_rm,
                                core_SC_P07_rm, core_SC_P08_rm, core_SC_P09_rm, core_SC_P10_rm, core_SC_P11_rm, core_SC_P12_rm,
                                core_SC_P13_rm, core_SC_P14_rm, core_SC_P15_rm, core_SC_P16_rm, core_SC_P17_rm, core_SC_P18_rm, 
                                core_SC_P19_rm, core_SC_P20_rm, core_SC_P21_rm, core_SC_P22_rm, core_SC_P23_rm, core_SC_P24_rm,
                                core_SC_P25_rm, core_SC_P26_rm, core_SC_P27_rm, core_SC_P28_rm, core_SC_P29_rm, core_SC_P30_rm,
                                core_SC_P31_rm, core_SC_P32_rm, core_SC_P34_rm, core_SC_P35_rm, core_SC_P36_rm, core_SC_P37_rm, 
                                core_SC_P38_rm, core_SC_P39_rm, core_SC_P40_rm, core_SC_P41_rm, core_SC_P42_rm, core_SC_P43_rm)

core_HANDS_rm <- merge_phyloseq(core_HANDS_P01_rm, core_HANDS_P02_rm, core_HANDS_P03_rm, core_HANDS_P04_rm, core_HANDS_P05_rm, core_HANDS_P06_rm,
                                core_HANDS_P07_rm, core_HANDS_P08_rm, core_HANDS_P09_rm, core_HANDS_P10_rm, core_HANDS_P11_rm, core_HANDS_P12_rm,
                                core_HANDS_P13_rm, core_HANDS_P14_rm, core_HANDS_P15_rm, core_HANDS_P16_rm, core_HANDS_P17_rm, core_HANDS_P18_rm, 
                                core_HANDS_P19_rm, core_HANDS_P20_rm, core_HANDS_P21_rm, core_HANDS_P22_rm, core_HANDS_P23_rm, core_HANDS_P24_rm,
                                core_HANDS_P25_rm, core_HANDS_P26_rm, core_HANDS_P27_rm, core_HANDS_P28_rm, core_HANDS_P29_rm, core_HANDS_P30_rm,
                                core_HANDS_P31_rm, core_HANDS_P32_rm, core_HANDS_P34_rm, core_HANDS_P35_rm, core_HANDS_P36_rm, core_HANDS_P37_rm, 
                                core_HANDS_P38_rm, core_HANDS_P39_rm, core_HANDS_P40_rm, core_HANDS_P41_rm, core_HANDS_P42_rm, core_HANDS_P43_rm)
```

#Scalp Diversity

```{r}
# Extract abundance matrix from the phyloseq object
Total_SC_rm_core_OTU = as(otu_table(core_SC_merge), "matrix")
# transpose if necessary
Total_SC_rm_core_OTU <- t(Total_SC_rm_core_OTU)
# Coerce to data.frame
Total_SC_rm_core_OTUdf = as.data.frame(Total_SC_rm_core_OTU)

#merge metadata file with alpha diversity measures:

#Remove samples from metadatafile that were removed from your phyloseq object (ie control samples, repeated samples, and other samples that are of other persons you are not using in this data set (P33, >P43))
Samples_toRemove <- c("HV_001_27", "HV_002_27", "HV_003_27", "HV_004_27", "HV_005_27", "HV_006_27", "HV_007_27", "HV_008_27",
                      "HV_009_27", "HV_010_27", "HV_011_27", "HV_012_27", "HV_013_27", "HV_014_27", "HV_015_27", "HV_016_27",
                      "HV_017_27", "HV_018_27", "HV_019_27", "HV_020_27", "HV_021_27", "HV_022_27", "HV_023_27", "HV_024_27",
                      "HV_025_27", "HV_026_27", "HV_027_27", "HV_028_27", "HV_029_27", "HV_030_27", "HV_015_20", "HV_015_21", 
                      "HV_020_22", "HV_027_02", "HV_027_03", "HV_027_04", "HV_027_05", "HV_027_06", "HV_027_07", "HV_020_10",
                      "HV_021_13", "HV_027_01")

Metadata_SC_rm_score_stat <- Metadata2[!grepl("HV_001_27", Metadata2$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_002_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_027_03", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_027_04", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_027_06", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_027_07", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_021_13", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_027_01", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_020_10", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_015_21", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_027_05", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_020_22", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_027_02", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_015_20", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_003_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_004_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_005_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_006_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_007_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_008_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_009_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_010_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_011_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_012_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_013_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_014_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_015_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_016_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_017_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_018_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_019_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_020_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_021_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_022_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_023_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_024_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_025_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_026_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_027_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_028_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_029_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("HV_030_27", Metadata_SC_rm_score_stat$SampleID),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("right", Metadata_SC_rm_score_stat$Location),]
Metadata_SC_rm_score_stat <- Metadata_SC_rm_score_stat[!grepl("left", Metadata_SC_rm_score_stat$Location),]

#alpha diversity measures:
Metadata_SC_rm_score_stat$shannon.vegan <- diversity(Total_SC_rm_core_OTUdf, index = "shannon")
Metadata_SC_rm_score_stat$simpson.vegan <- diversity(Total_SC_rm_core_OTUdf, index = "simpson")
Metadata_SC_rm_score_stat$invsimpson.vegan <- diversity(Total_SC_rm_core_OTUdf, index = "invsimpson")
```

#ANOVA of alpha diversity measures using shannon (can be repeated for simpson)
```{r}
model_SC_rm_core_AOV <- aov(shannon.vegan~Gender+ Subject/Time_Week+Subject, data = Metadata_SC_rm_score_stat)
summary(model_SC_rm_core_AOV)
```

```{r}
norm_SC_rm <- transform_sample_counts(core_SC_all_rm , function(x) x / sum(x) )
ord.SC_rm <- ordinate(norm_SC_rm, method="PCoA", distance="jaccard")
plot_ordination(norm_SC_rm, ord.SC_rm, color = "Subject", shape = "Time_Collected") +
  geom_point(size=1)
```
```{r}
metadata_SC_rm <- as(sample_data(norm_SC_rm ), "data.frame")
adonis(phyloseq::distance(norm_SC_rm, method="jaccard") ~  Gender+ Subject/Time_Week+Subject,
       data = metadata_SC_rm)
```


#Hands Diversity

```{r}
# Extract abundance matrix from the phyloseq object
Total_HANDS_rm_core_OTU = as(otu_table(core_HANDS_rm), "matrix")
# transpose if necessary
Total_HANDS_rm_core_OTU <- t(Total_HANDS_rm_core_OTU)
# Coerce to data.frame
Total_HANDS_rm_core_OTUdf = as.data.frame(Total_HANDS_rm_core_OTU)

#merge metadata file with alpha diversity measures:

#Remove samples from metadatafile that were removed from your phyloseq object (ie control samples, repeated samples, and other samples that are of other persons you are not using in this data set (P33, >P43))
Samples_toRemove <- c("HV_001_27", "HV_002_27", "HV_003_27", "HV_004_27", "HV_005_27", "HV_006_27", "HV_007_27", "HV_008_27",
                      "HV_009_27", "HV_010_27", "HV_011_27", "HV_012_27", "HV_013_27", "HV_014_27", "HV_015_27", "HV_016_27",
                      "HV_017_27", "HV_018_27", "HV_019_27", "HV_020_27", "HV_021_27", "HV_022_27", "HV_023_27", "HV_024_27",
                      "HV_025_27", "HV_026_27", "HV_027_27", "HV_028_27", "HV_029_27", "HV_030_27", "HV_015_20", "HV_015_21", 
                      "HV_020_22", "HV_027_02", "HV_027_03", "HV_027_04", "HV_027_05", "HV_027_06", "HV_027_07", "HV_020_10",
                      "HV_021_13", "HV_027_01")

Metadata_HANDS_rm_HANDSore_stat <- Metadata2[!grepl("HV_001_27", Metadata2$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_002_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_027_03", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_027_04", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_027_06", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_027_07", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_021_13", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_027_01", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_020_10", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_015_21", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_027_05", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_020_22", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_027_02", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_015_20", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_003_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_004_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_005_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_006_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_007_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_008_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_009_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_010_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_011_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_012_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_013_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_014_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_015_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_016_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_017_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_018_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_019_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_020_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_021_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_022_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_023_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_024_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_025_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_026_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_027_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_028_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_029_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("HV_030_27", Metadata_HANDS_rm_HANDSore_stat$SampleID),]
Metadata_HANDS_rm_HANDSore_stat <- Metadata_HANDS_rm_HANDSore_stat[!grepl("scalp", Metadata_HANDS_rm_HANDSore_stat$Location),]


#alpha diversity measures:
Metadata_HANDS_rm_HANDSore_stat$shannon.vegan <- diversity(Total_HANDS_rm_core_OTUdf, index = "shannon")
Metadata_HANDS_rm_HANDSore_stat$simpson.vegan <- diversity(Total_HANDS_rm_core_OTUdf, index = "simpson")
Metadata_HANDS_rm_HANDSore_stat$invsimpson.vegan <- diversity(Total_HANDS_rm_core_OTUdf, index = "invsimpson")
```

#ANOVA of alpha diversity measures using shannon (can be repeated for simpson)
```{r, echo=FALSE, out.width="100%"}
model_HANDS_rm_core_AOV <- aov(shannon.vegan~ Gender+ Subject + Subject/Location+ Subject/Time_Collected, data = Metadata_HANDS_rm_HANDSore_stat)
summary(model_HANDS_rm_core_AOV)
knitr::opts_chunk$set(fig.width=12, fig.height=8) 
plot_richness(core_HANDS_rm, color = "Subject", x = "Time_Collected")

```

```{r}
norm_HANDS_rm <- transform_sample_counts(core_HANDS_rm , function(x) x / sum(x) )
ord.HANDS_rm <- ordinate(norm_HANDS_rm, method="PCoA", distance="bray")
plot_ordination(norm_HANDS_rm, ord.HANDS_rm, color = "Subject", shape = "Time_Collected") +
  geom_point(size=1)
```
```{r}
metadata_HANDS_rm <- as(sample_data(norm_HANDS_rm ), "data.frame")
adonis(phyloseq::distance(norm_HANDS_rm, method="bray") ~  Gender+Subject/Location+ Subject/Time_Collected+Subject,,
       data = metadata_HANDS_rm)
```

```{r}
# Calculate bray curtis distance matrix
erie_bray <- phyloseq::distance(norm_HANDS_rm, method = "bray")

# make a data frame from the sample_data
sampledf <- data.frame(sample_data(core_HANDS_rm))

# Adonis test
adonis(erie_bray ~ Gender+ Subject/Time_Week+Subject, data = sampledf)

# Homogeneity of dispersion test
beta <- betadisper(erie_bray, sampledf$Subject)
permutest(beta)
```

#left Diversity

```{r}
# Extract abundance matrix from the phyloseq object
Total_LH_rm_core_OTU = as(otu_table(core_LH_rm), "matrix")
# transpose if necessary
Total_LH_rm_core_OTU <- t(Total_LH_rm_core_OTU)
# Coerce to data.frame
Total_LH_rm_core_OTUdf = as.data.frame(Total_LH_rm_core_OTU)

#merge metadata file with alpha diversity measures:

#Remove samples from metadatafile that were removed from your phyloseq object (ie control samples, repeated samples, and other samples that are of other persons you are not using in this data set (P33, >P43))
Samples_toRemove <- c("HV_001_27", "HV_002_27", "HV_003_27", "HV_004_27", "HV_005_27", "HV_006_27", "HV_007_27", "HV_008_27",
                      "HV_009_27", "HV_010_27", "HV_011_27", "HV_012_27", "HV_013_27", "HV_014_27", "HV_015_27", "HV_016_27",
                      "HV_017_27", "HV_018_27", "HV_019_27", "HV_020_27", "HV_021_27", "HV_022_27", "HV_023_27", "HV_024_27",
                      "HV_025_27", "HV_026_27", "HV_027_27", "HV_028_27", "HV_029_27", "HV_030_27", "HV_015_20", "HV_015_21", 
                      "HV_020_22", "HV_027_02", "HV_027_03", "HV_027_04", "HV_027_05", "HV_027_06", "HV_027_07", "HV_020_10",
                      "HV_021_13", "HV_027_01")

Metadata_LH_rm_LHore_stat <- Metadata2[!grepl("HV_001_27", Metadata2$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_002_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_027_03", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_027_04", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_027_06", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_027_07", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_021_13", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_027_01", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_020_10", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_015_21", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_027_05", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_020_22", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_027_02", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_015_20", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_003_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_004_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_005_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_006_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_007_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_008_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_009_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_010_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_011_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_012_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_013_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_014_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_015_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_016_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_017_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_018_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_019_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_020_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_021_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_022_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_023_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_024_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_025_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_026_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_027_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_028_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_029_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("HV_030_27", Metadata_LH_rm_LHore_stat$SampleID),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("right", Metadata_LH_rm_LHore_stat$Location),]
Metadata_LH_rm_LHore_stat <- Metadata_LH_rm_LHore_stat[!grepl("scalp", Metadata_LH_rm_LHore_stat$Location),]

#alpha diversity measures:
Metadata_LH_rm_LHore_stat$shannon.vegan <- diversity(Total_LH_rm_core_OTUdf, index = "shannon")
Metadata_LH_rm_LHore_stat$simpson.vegan <- diversity(Total_LH_rm_core_OTUdf, index = "simpson")
Metadata_LH_rm_LHore_stat$invsimpson.vegan <- diversity(Total_LH_rm_core_OTUdf, index = "invsimpson")
```

#ANOVA of alpha diversity measures using shannon (can be repeated for simpson)
```{r}
model_LH_rm_core_AOV <- aov(shannon.vegan~Gender+ Subject/Time_Week+Subject, data = Metadata_LH_rm_LHore_stat)
summary(model_LH_rm_core_AOV)
```

```{r}
norm_LH_rm <- transform_sample_counts(core_LH_rm , function(x) x / sum(x) )
ord.LH_rm <- ordinate(norm_LH_rm, method="PCoA", distance="bray")
plot_ordination(norm_LH_rm, ord.LH_rm, color = "Subject", shape = "Time_Collected") +
  geom_point(size=1)
```
```{r}
metadata_LH_rm <- as(sample_data(norm_LH_rm ), "data.frame")
adonis(phyloseq::distance(norm_LH_rm, method="bray") ~  Gender+ Subject/Time_Week+Subject,
       data = metadata_LH_rm)

# Calculate bray curtis distance matrix
erie_bray <- phyloseq::distance(norm_LH_rm, method = "bray")
erie_bray <- data.frame(erie_bray)
# make a data frame from the sample_data
sampledf <- data.frame(sample_data(core_LH_rm))

# Adonis test
adonis(erie_bray ~ Gender+ Subject/Time_Week+Subject, data = sampledf)

# Homogeneity of dispersion test
beta <- betadisper(erie_bray, sampledf$Subjec)
permutest(beta)
```


#Right Diversity

```{r}
# Extract abundance matrix from the phyloseq object
Total_RH_rm_core_OTU = as(otu_table(core_RH_merge), "matrix")
# transpose if necessary
Total_RH_rm_core_OTU <- t(Total_RH_rm_core_OTU)
# Coerce to data.frame
Total_RH_rm_core_OTUdf = as.data.frame(Total_RH_rm_core_OTU)

#merge metadata file with alpha diversity measures:

#Remove samples from metadatafile that were removed from your phyloseq object (ie control samples, repeated samples, and other samples that are of other persons you are not using in this data set (P33, >P43))
Samples_toRemove <- c("HV_001_27", "HV_002_27", "HV_003_27", "HV_004_27", "HV_005_27", "HV_006_27", "HV_007_27", "HV_008_27",
                      "HV_009_27", "HV_010_27", "HV_011_27", "HV_012_27", "HV_013_27", "HV_014_27", "HV_015_27", "HV_016_27",
                      "HV_017_27", "HV_018_27", "HV_019_27", "HV_020_27", "HV_021_27", "HV_022_27", "HV_023_27", "HV_024_27",
                      "HV_025_27", "HV_026_27", "HV_027_27", "HV_028_27", "HV_029_27", "HV_030_27", "HV_015_20", "HV_015_21", 
                      "HV_020_22", "HV_027_02", "HV_027_03", "HV_027_04", "HV_027_05", "HV_027_06", "HV_027_07", "HV_020_10",
                      "HV_021_13", "HV_027_01")

Metadata_RH_rm_RHore_stat <- Metadata2[!grepl("HV_001_27", Metadata2$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_002_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_027_03", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_027_04", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_027_06", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_027_07", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_021_13", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_027_01", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_020_10", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_015_21", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_027_05", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_020_22", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_027_02", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_015_20", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_003_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_004_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_005_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_006_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_007_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_008_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_009_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_010_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_011_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_012_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_013_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_014_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_015_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_016_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_017_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_018_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_019_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_020_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_021_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_022_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_023_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_024_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_025_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_026_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_027_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_028_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_029_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("HV_030_27", Metadata_RH_rm_RHore_stat$SampleID),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("scalp", Metadata_RH_rm_RHore_stat$Location),]
Metadata_RH_rm_RHore_stat <- Metadata_RH_rm_RHore_stat[!grepl("left", Metadata_RH_rm_RHore_stat$Location),]

#alpha diversity measures:
Metadata_RH_rm_RHore_stat$shannon.vegan <- diversity(Total_RH_rm_core_OTUdf, index = "shannon")
Metadata_RH_rm_RHore_stat$simpson.vegan <- diversity(Total_RH_rm_core_OTUdf, index = "simpson")
Metadata_RH_rm_RHore_stat$invsimpson.vegan <- diversity(Total_RH_rm_core_OTUdf, index = "invsimpson")
```

#ANOVA of alpha diversity measures using shannon (can be repeated for simpson)
```{r}
model_RH_rm_core_AOV <- aov(shannon.vegan~Gender+ Subject/Time_Week+Subject, data = Metadata_RH_rm_RHore_stat)
summary(model_RH_rm_core_AOV)
```

```{r}
norm_RH_rm <- transform_sample_counts(core_RH_merge , function(x) x / sum(x) )
ord.RH_rm <- ordinate(norm_RH_rm, method="PCoA", distance="bray")
plot_ordination(norm_RH_rm, ord.RH_rm, color = "Subject", shape = "Time_Collected") +
  geom_point(size=1)
```
```{r}
metadata_RH_rm <- as(sample_data(norm_RH_rm ), "data.frame")
adonis(phyloseq::distance(norm_RH_rm, method="bray") ~  Gender+ Subject/Time_Week+Subject,
       data = metadata_RH_rm)
```



```{r}
#library( "DESeq2" )
diagdds_pre = phyloseq_to_deseq2(core_total_merge, ~ Subject)
diagdds = DESeq(diagdds_pre, fitType="local")
```
````{r}
res = results(diagdds, cooksCutoff = FALSE)
#res_IBK = res[order(res$padj, na.last = NA), ]
alpha = 0.05
keepOTUs_IBK_ulcer = rownames(res_IBK[res_IBK$padj < alpha, ])[1:50] #looking at top diff asvs between pre and post infection
kosticTrimvs_IBK_ulcer = prune_taxa(keepOTUs_IBK_ulcer, core_total_merge)
kosticTrimvs_IBK_ulcer
orm_desq <- transform_sample_counts(kosticTrimvs_IBK_ulcer , function(x) x / sum(x) )
test <- otu_table(kosticTrimvs_IBK_ulcer) 
test <- as.data.frame(test)
dim(test)
test2 <- data.frame(t(test[-1]))
test2$SampleID <- row.names(test2)
test_overall <- merge(DESEQ_Metadata_core_stat,test2, by="SampleID")
test_overall2<-test_overall 
names(test_overall2)[names(test_overall2) == "Additional notes"] <- "Additional"
test_overall2 <-  subset(test_overall2, select = -c(SampleID, Raw_seq_name, File_Name, Time_Week, Index_Used, Control, DNase_trt, Month_Sampled, Day_Sampled, Year_Sampled, Date_Sampled, Gender, Seven_Day_Travel_Local, Seven_Day_Travel_Foreign, Time_Since_Last_Washed_Hands, Antibacterial_Soap_Used, Gel_Sanitizer_Use, Time_Since_Gel_Sanitizer, Hand_Lotion_Use, Time_Since_Lotion, Time_Since_Hair_Wash, Swam_in_Chlorine_Pool, Time_Since_Swim, Tanning_Bed_Use, Time_Since_tanning, Animal_Contact, Animal_Type, Additional, shannon.vegan, simpson.vegan, invsimpson.vegan))
```{r}

test_LH<-test_overall2[!(test_overall2$Location=="right"),]
test_LH<-test_LH[!(test_LH$Location=="scalp"),]
test_LH_T0<-test_LH[!(test_LH$Time_Collected=="2_week"),]
test_LH_T0<-test_LH_T0[!(test_LH_T0$Time_Collected=="1_month"),]
test_LH_T0<-test_LH_T0[!(test_LH_T0$Time_Collected=="3_month"),]
test_LH_T0<-test_LH_T0[!(test_LH_T0$Time_Collected=="6_month"),]
test_LH_T0 <-subset(test_LH_T0, select = -c(Location, Time_Collected))
row.names(test_LH_T0) <- test_LH_T0$Subject
test_LH_T0 <-subset(test_LH_T0, select = -c(Subject))


test_LH_T0 <- as.matrix(test_LH_T0)
test_LH_T0<- t(test_LH_T0)
Heatmap(test_LH_T0)
`````

```{r}
test_LH<-test_overall2[!(test_overall2$Location=="right"),]
test_LH<-test_LH[!(test_LH$Location=="scalp"),]
test_LH_T1<-test_LH[!(test_LH$Time_Collected=="T_0"),]
test_LH_T1<-test_LH_T1[!(test_LH_T1$Time_Collected=="1_month"),]
test_LH_T1<-test_LH_T1[!(test_LH_T1$Time_Collected=="3_month"),]
test_LH_T1<-test_LH_T1[!(test_LH_T1$Time_Collected=="6_month"),]
test_LH_T1 <-subset(test_LH_T1, select = -c(Location, Time_Collected))
row.names(test_LH_T1) <- test_LH_T1$Subject
test_LH_T1 <-subset(test_LH_T1, select = -c(Subject))
k127_12842510
View(test_LH_T1)
test_LH_T1 <- as.matrix(test_LH_T1)
test_LH_T1<- t(test_LH_T1)
col_fun = colorRamp2(c(0, 0.2, 0.4), c("white", "#66CCFF", "#000033"))
col_fun2 = colorRamp2(c(0, 0.4), c("#000033", "#66CCFF"))
Heatmap(test_LH_T1, name = "Relative Abundance", column_title = "Subject", row_title = "Viral Contig", column_title_side = "bottom", row_dend_width = unit(2, "cm"), column_dend_height = unit(2, "cm"),  col = col_fun)
Heatmap(test_LH_T1, name = "Relative Abundance", column_title = "Subject", row_title = "Viral Contig", column_title_side = "bottom", row_dend_width = unit(2, "cm"), column_dend_height = unit(2, "cm"),  col = col_fun2)
Heatmap(test_LH_T1, name = "Relative Abundance", column_title = "Subject", row_title = "Viral Contig", column_title_side = "bottom", row_dend_width = unit(2, "cm"), column_dend_height = unit(2, "cm"))
```

```{r}
hmap <- subset_taxa(core_total_merge, phylum=="k127_712808" )
plot_bar(hmap, x="Subject", facet_grid= "Time_Week")
```
```{r}
library("circlize")
PARE_otu<- otu_table
View(PARE_otu_m)
PARE_otu_m <- as.matrix(PARE_otu)
chordDiagram(PARE_otu_m)
```


```{r}
r_name <- c("PARE")
chord_p <- data.frame(row.names = r_name )
chord_p$P01 <- 0
chord_p$P02 <- 0
chord_p$P03 <- 0
chord_p$P04 <- 0
chord_p$P05 <- 0
chord_p$P06 <- 0
chord_p$P07 <- 0
chord_p$P08 <- 0
chord_p$P09 <- 0
chord_p$P10 <- 0
chord_p$P11 <- 0
chord_p$P12 <- 0
chord_p$P13 <- 0
chord_p$P14 <- 0
chord_p$P15 <- 0
chord_p$P16 <- 0
chord_p$P17 <- 0
chord_p$P18 <- 0
chord_p$P19 <- 0
chord_p$P20 <- 0
chord_p$P21 <- 0
chord_p$P22 <- 0
chord_p$P23 <- 0
chord_p$P24 <- 0
chord_p$P25 <- 0
chord_p$P26 <- 0
chord_p$P27 <- 0
chord_p$P28 <- 0
chord_p$P29 <- 0
chord_p$P30 <- 0
chord_p$P31 <- 0
chord_p$P32 <- 0
chord_p$P34 <- 0
chord_p$P35 <- 0
chord_p$P36 <- 0
chord_p$P37 <- 0
chord_p$P38 <- 0
chord_p$P39 <- 0
chord_p$P40 <- 0
chord_p$P41 <- 0
chord_p$P42 <- 0
chord_p$P43 <- 0
```

```{r}
PARE <- hmap 
P01_PARE<- subset_samples(PARE, Subject=="P01")
otu_table(P01_PARE)
chord_p["PARE","P01"] = taxa_sums(P01_PARE)
remove(P01_PARE)

P02_PARE<- subset_samples(PARE, Subject=="P02")
otu_table(P02_PARE)
chord_p["PARE","P02"] = taxa_sums(P02_PARE)
remove(P02_PARE)

P03_PARE<- subset_samples(PARE, Subject=="P03")
otu_table(P03_PARE)
chord_p["PARE","P03"] = taxa_sums(P03_PARE)
remove(P03_PARE)

P04_PARE<- subset_samples(PARE, Subject=="P04")
otu_table(P04_PARE)
chord_p["PARE","P04"] = taxa_sums(P04_PARE)
remove(P04_PARE)

P05_PARE<- subset_samples(PARE, Subject=="P05")
otu_table(P05_PARE)
chord_p["PARE","P05"] = taxa_sums(P05_PARE)
remove(P05_PARE)

P06_PARE<- subset_samples(PARE, Subject=="P06")
otu_table(P06_PARE)
chord_p["PARE","P06"] = taxa_sums(P06_PARE)
remove(P06_PARE)

P07_PARE<- subset_samples(PARE, Subject=="P07")
otu_table(P07_PARE)
chord_p["PARE","P07"] = taxa_sums(P07_PARE)
remove(P07_PARE)

P08_PARE<- subset_samples(PARE, Subject=="P08")
otu_table(P08_PARE)
chord_p["PARE","P08"] = taxa_sums(P08_PARE)
remove(P08_PARE)

P09_PARE<- subset_samples(PARE, Subject=="P09")
otu_table(P09_PARE)
chord_p["PARE","P09"] = taxa_sums(P09_PARE)
remove(P09_PARE)

P10_PARE<- subset_samples(PARE, Subject=="P10")
otu_table(P10_PARE)
chord_p["PARE","P10"] = taxa_sums(P10_PARE)
remove(P10_PARE)

P11_PARE<- subset_samples(PARE, Subject=="P11")
otu_table(P11_PARE)
chord_p["PARE","P11"] = taxa_sums(P11_PARE)
remove(P11_PARE)

P12_PARE<- subset_samples(PARE, Subject=="P12")
otu_table(P12_PARE)
chord_p["PARE","P12"] = taxa_sums(P12_PARE)
remove(P12_PARE)

P13_PARE<- subset_samples(PARE, Subject=="P13")
otu_table(P13_PARE)
chord_p["PARE","P13"] = taxa_sums(P13_PARE)
remove(P13_PARE)

P14_PARE<- subset_samples(PARE, Subject=="P14")
otu_table(P14_PARE)
chord_p["PARE","P14"] = taxa_sums(P14_PARE)
remove(P14_PARE)

P15_PARE<- subset_samples(PARE, Subject=="P15")
otu_table(P15_PARE)
chord_p["PARE","P15"] = taxa_sums(P15_PARE)
remove(P15_PARE)

P16_PARE<- subset_samples(PARE, Subject=="P16")
otu_table(P16_PARE)
chord_p["PARE","P16"] = taxa_sums(P16_PARE)
remove(P16_PARE)

P17_PARE<- subset_samples(PARE, Subject=="P17")
otu_table(P17_PARE)
chord_p["PARE","P17"] = taxa_sums(P17_PARE)
remove(P17_PARE)

P18_PARE<- subset_samples(PARE, Subject=="P18")
otu_table(P18_PARE)
chord_p["PARE","P18"] = taxa_sums(P18_PARE)
remove(P18_PARE)

P19_PARE<- subset_samples(PARE, Subject=="P19")
otu_table(P19_PARE)
chord_p["PARE","P19"] = taxa_sums(P19_PARE)
remove(P19_PARE)

P20_PARE<- subset_samples(PARE, Subject=="P20")
otu_table(P20_PARE)
chord_p["PARE","P20"] = taxa_sums(P20_PARE)
remove(P20_PARE)

P21_PARE<- subset_samples(PARE, Subject=="P21")
otu_table(P21_PARE)
chord_p["PARE","P21"] = taxa_sums(P21_PARE)
remove(P21_PARE)

P22_PARE<- subset_samples(PARE, Subject=="P22")
otu_table(P22_PARE)
chord_p["PARE","P22"] = taxa_sums(P22_PARE)
remove(P22_PARE)

P23_PARE<- subset_samples(PARE, Subject=="P23")
otu_table(P23_PARE)
chord_p["PARE","P23"] = taxa_sums(P23_PARE)
remove(P23_PARE)

P24_PARE<- subset_samples(PARE, Subject=="P24")
otu_table(P24_PARE)
chord_p["PARE","P24"] = taxa_sums(P24_PARE)
remove(P24_PARE)

P25_PARE<- subset_samples(PARE, Subject=="P25")
otu_table(P25_PARE)
chord_p["PARE","P25"] = taxa_sums(P25_PARE)
remove(P25_PARE)

P26_PARE<- subset_samples(PARE, Subject=="P26")
otu_table(P26_PARE)
chord_p["PARE","P26"] = taxa_sums(P26_PARE)
remove(P26_PARE)

P27_PARE<- subset_samples(PARE, Subject=="P27")
otu_table(P27_PARE)
chord_p["PARE","P27"] = taxa_sums(P27_PARE)
remove(P27_PARE)

P28_PARE<- subset_samples(PARE, Subject=="P28")
otu_table(P28_PARE)
chord_p["PARE","P28"] = taxa_sums(P28_PARE)
remove(P28_PARE)

P29_PARE<- subset_samples(PARE, Subject=="P29")
otu_table(P29_PARE)
chord_p["PARE","P29"] = taxa_sums(P29_PARE)
remove(P29_PARE)

P30_PARE<- subset_samples(PARE, Subject=="P30")
otu_table(P30_PARE)
chord_p["PARE","P30"] = taxa_sums(P30_PARE)
remove(P30_PARE)

P31_PARE<- subset_samples(PARE, Subject=="P31")
otu_table(P31_PARE)
chord_p["PARE","P31"] = taxa_sums(P31_PARE)
remove(P31_PARE)

P32_PARE<- subset_samples(PARE, Subject=="P32")
otu_table(P32_PARE)
chord_p["PARE","P32"] = taxa_sums(P32_PARE)
remove(P32_PARE)

P34_PARE<- subset_samples(PARE, Subject=="P34")
otu_table(P34_PARE)
chord_p["PARE","P34"] = taxa_sums(P34_PARE)
remove(P34_PARE)

P35_PARE<- subset_samples(PARE, Subject=="P35")
otu_table(P35_PARE)
chord_p["PARE","P35"] = taxa_sums(P35_PARE)
remove(P35_PARE)

P36_PARE<- subset_samples(PARE, Subject=="P36")
otu_table(P36_PARE)
chord_p["PARE","P36"] = taxa_sums(P36_PARE)
remove(P36_PARE)

P37_PARE<- subset_samples(PARE, Subject=="P37")
otu_table(P37_PARE)
chord_p["PARE","P37"] = taxa_sums(P37_PARE)
remove(P37_PARE)

P38_PARE<- subset_samples(PARE, Subject=="P38")
otu_table(P38_PARE)
chord_p["PARE","P38"] = taxa_sums(P38_PARE)
remove(P38_PARE)

P39_PARE<- subset_samples(PARE, Subject=="P39")
otu_table(P39_PARE)
chord_p["PARE","P39"] = taxa_sums(P39_PARE)
remove(P39_PARE)

P40_PARE<- subset_samples(PARE, Subject=="P40")
otu_table(P40_PARE)
chord_p["PARE","P40"] = taxa_sums(P40_PARE)
remove(P40_PARE)

P41_PARE<- subset_samples(PARE, Subject=="P41")
otu_table(P41_PARE)
chord_p["PARE","P41"] = taxa_sums(P41_PARE)
remove(P41_PARE)

P42_PARE<- subset_samples(PARE, Subject=="P42")
otu_table(P42_PARE)
chord_p["PARE","P42"] = taxa_sums(P42_PARE)
remove(P42_PARE)

P43_PARE<- subset_samples(PARE, Subject=="P43")
otu_table(P43_PARE)
chord_p["PARE","P43"] = taxa_sums(P43_PARE)
remove(P43_PARE)
```
```{r}
```{r}
chord_p$AMR_Gene <- rownames(chord_p)
chord_p_fix <- pivot_longer(chord_p, cols =1:42, names_to = "Subject", values_to = "Abundance"  )
```

```{r}
#library("circlize")

PARE_p <- chord_p[!(row.names(chord_p) %in% c("ERMC","MSRD","MLS23S","GYRA","QACF_ANTIPRIME3")), ]
PARE_p$AMR_Gene <- rownames(PARE_p)
PARE_p_fix <- pivot_longer(PARE_p, cols =1:42, names_to = "Subject", values_to = "Abundance"  )
```

```{r}
#parameters
circos.clear()
circos.par(start.degree = -55, gap.degree = 5, track.margin = c(-0.1, 0.1), points.overflow.warning = FALSE)
par(mar = rep(0, 4))

# Base plot
chordDiagram(
  x = PARE_p_fix, 
  transparency = 0.25,
  directional = 1,
  direction.type = c("arrows", "diffHeight"), 
  diffHeight  = -0.04,
  annotationTrack = "grid", 
  annotationTrackHeight = c(0.05, 0.1),
  link.arr.type = "big.arrow", 
  link.sort = TRUE, 
  link.largest.ontop = TRUE)

# Add text and axis
circos.trackPlotRegion(
  track.index = 1, 
  bg.border = NA, 
  panel.fun = function(x, y) {
    
    xlim = get.cell.meta.data("xlim")
    sector.index = get.cell.meta.data("sector.index")
    
    # Add names to the sector. 
    circos.text(
      x = mean(xlim), 
      y = 2, 
      labels = sector.index, 
      adj = c(0, degree(1)), 
      facing = "clockwise",
      cex = 0.6
      )
  }
)
```
```
```

RH_Metadata_core_stat2$Time_Collected[which(RH_Metadata_core_stat2$Time_Collected == "T_0")] <-"T1"
RH_Metadata_core_stat2$Time_Collected[which(RH_Metadata_core_stat2$Time_Collected == "2_week")] <-"T2"
RH_Metadata_core_stat2$Time_Collected[which(RH_Metadata_core_stat2$Time_Collected == "1_month")] <-"T3"
RH_Metadata_core_stat2$Time_Collected[which(RH_Metadata_core_stat2$Time_Collected == "3_month")] <-"T4"
RH_Metadata_core_stat2$Time_Collected[which(RH_Metadata_core_stat2$Time_Collected == "6_month")] <-"T5"
library(reshape2)
mat <- dcast(RH_Metadata_core_stat2, Subject~Time_Collected, value.var="shannon.vegan")
rownames(mat) <- mat[,1]
mat[,1] <- NULL
mat<- as.matrix(mat)
Heatmap(mat)



meta
orm_desq <- transform_sample_counts(kosticTrimvs_IBK_ulcer , function(x) x / sum(x) )

plot_bar(orm_desq, fill="phylum", facet_grid=~Subject)
plot_heatmap(orm_desq, method = NULL, sample.order = "Time_Collected", na.value = "black" )
#View(kosticTrimvs_IBK)


res = results(diagdds, cooksCutoff = FALSE)
alpha = 0.01
sigtab = res[which(res$padj < alpha), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(core_total_merge)[rownames(sigtab), ], "matrix"))
head(sigtab)
dim(sigtab)


theme_set(theme_bw())
scale_fill_discrete <- function(palname = "Set1", ...) {
    scale_fill_brewer(palette = palname, ...)
}
# Phylum order
x = tapply(sigtab$log2FoldChange, sigtab$Bin, function(x) max(x))
x = sort(x, TRUE)
sigtab$Bin = factor(as.character(sigtab$Bin), levels=names(x))
# Bin order
x = tapply(sigtab$log2FoldChange, sigtab$Bin, function(x) max(x))
x = sort(x, TRUE)
sigtab$Bin = factor(as.character(sigtab$Bin), levels=names(x))
ggplot(sigtab, aes(x=Bin, y=log2FoldChange)) + geom_point(size=2) + 
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5))



res = res[order(res$padj, na.last = NA), ]
alpha = 0.01
keepOTUs_IBK_ulcer = rownames(res[res$padj < alpha, ]) #looking at top diff asvs between pre and post infection
deseq_map<- subset_taxa(core_total_merge, (phylum %in% keepOTUs_IBK_ulcer) )
norm_desq <- transform_sample_counts(deseq_map , function(x) x / sum(x) )

plot_heatmap(norm_desq, "MDS", "bray", "Subject", "Bin", weighted=FALSE)

deseq.sum<- tapply(taxa_sums(deseq_map), tax_table(deseq_map)[, "Bin"], sum, na.rm=TRUE)
deseq_top10phyla <-names(sort(deseq.sum, TRUE))[1:50]
deseq_top10 <- prune_taxa((tax_table(deseq_map)[, "Bin"] %in% deseq_top10phyla), deseq_map)
plot_heatmap(deseq_top10, sample.label="Subject")
norm_desq <- transform_sample_counts(deseq_top10 , function(x) x / sum(x) )
plot_bar(deseq_top10, x="Subject", fill = "Bin")

heatmap <- ggplot(norm_desq, aes(x=variable, y=Gene, fill=value)) + geom_raster() + theme(axis.text.x=element_text(angle=65, hjust=1), axis.text.y=element_blank(), axis.ticks.y=element_blank())
heatmap








norm_desq <- transform_sample_counts(core_total_merge , function(x) x / sum(x) )
kosticTrimvs_IBK_ulcer = prune_taxa(keepOTUs_IBK_ulcer, norm_desq)
kosticTrimvs_IBK_ulcer
#View(kosticTrimvs_IBK)

plot_heatmap(norm_desq, distance = "bray", na.value = "black",  sample.label = "Subject", sample.order = "Time_Collected")
?plot_heatmap()

deseq2Results <- results(diagdds)
summary(deseq2Results)
plotMA(deseq2Results)
deseq2ResDF <- as.data.frame(deseq2Results)

deseq2VST <- vst(diagdds)
deseq2VST <- assay(deseq2VST)
deseq2VST <- as.data.frame(deseq2VST)
deseq2VST$Gene <- rownames(deseq2VST)
head(deseq2VST)

sigGenes <- rownames(deseq2ResDF[deseq2ResDF$padj <= .05 & abs(deseq2ResDF$log2FoldChange) > 3,])
deseq2VST <- deseq2VST[deseq2VST$Gene %in% sigGenes,]
library(reshape2)

deseq2VST_wide <- deseq2VST
deseq2VST_long <- melt(deseq2VST, id.vars=c("Gene"))

deseq2VST <- melt(deseq2VST, id.vars=c("Gene"))

deseq2VST %>% 
  rename(
    sepal_length = Gene,
    )

heatmap <- ggplot(deseq2VST, aes(x=variable, y=Gene, fill=value)) + geom_raster() + theme(axis.text.x=element_text(angle=65, hjust=1), axis.text.y=element_blank(), axis.ticks.y=element_blank())
heatmap


```{r}
#kosticTrimvs_IBK_ulcer_HAND <- subset_samples(kosticTrimvs_IBK_ulcer, !(Location=="scalp"))

# Extract abundance matrix from the phyloseq object
DESEQ_core_OTU = as(otu_table(kosticTrimvs_IBK_ulcer), "matrix")
# transpose if necessary
DESEQ_core_OTU <- t(DESEQ_core_OTU)
# Coerce to data.frame
DESEQ_core_OTUdf = as.data.frame(DESEQ_core_OTU)

#merge metadata file with alpha diversity measures:

#Remove samples from metadatafile that were removed from your phyloseq object (ie control samples, repeated samples, and other samples that are of other persons you are not using in this data set (P33, >P43))
Samples_toRemove <- c("HV_001_27", "HV_002_27", "HV_003_27", "HV_004_27", "HV_005_27", "HV_006_27", "HV_007_27", "HV_008_27",
                      "HV_009_27", "HV_010_27", "HV_011_27", "HV_012_27", "HV_013_27", "HV_014_27", "HV_015_27", "HV_016_27",
                      "HV_017_27", "HV_018_27", "HV_019_27", "HV_020_27", "HV_021_27", "HV_022_27", "HV_023_27", "HV_024_27",
                      "HV_025_27", "HV_026_27", "HV_027_27", "HV_028_27", "HV_029_27", "HV_030_27", "HV_015_20", "HV_015_21", 
                      "HV_020_22", "HV_027_02", "HV_027_03", "HV_027_04", "HV_027_05", "HV_027_06", "HV_027_07", "HV_020_10",
                      "HV_021_13", "HV_027_01")

DESEQ_Metadata_core_stat <- Metadata2[!grepl("HV_001_27", Metadata2$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_002_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_027_03", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_027_04", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_027_06", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_027_07", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_021_13", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_027_01", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_020_10", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_015_21", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_027_05", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_020_22", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_027_02", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_015_20", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_003_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_004_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_005_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_006_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_007_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_008_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_009_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_010_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_011_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_012_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_013_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_014_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_015_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_016_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_017_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_018_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_019_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_020_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_021_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_022_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_023_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_024_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_025_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_026_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_027_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_028_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_029_27", DESEQ_Metadata_core_stat$SampleID),]
DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("HV_030_27", DESEQ_Metadata_core_stat$SampleID),]
#DESEQ_Metadata_core_stat <- DESEQ_Metadata_core_stat[!grepl("scalp", DESEQ_Metadata_core_stat$Location),]
#alpha diversity measures:
DESEQ_Metadata_core_stat$shannon.vegan <- diversity(DESEQ_core_OTUdf, index = "shannon")
DESEQ_Metadata_core_stat$simpson.vegan <- diversity(DESEQ_core_OTUdf, index = "simpson")
DESEQ_Metadata_core_stat$invsimpson.vegan <- diversity(DESEQ_core_OTUdf, index = "invsimpson")
```

#ANOVA of alpha diversity measures using shannon (can be repeated for simpson)
```{r}
model_DESEQ_AOV <- aov(shannon.vegan~Gender+Subject/Location+ Subject/Time_Week+Subject, data = DESEQ_Metadata_core_stat)
summary(model_DESEQ_AOV)
```

```{r}
norm_DESEQ <- transform_sample_counts(kosticTrimvs_IBK_ulcer, function(x) x / sum(x) )
norm_DESEQ <- prune_samples(sample_sums(norm_DESEQ) >= 1, norm_DESEQ)
ord.DESEQ <- ordinate(norm_DESEQ, method="PCoA", distance="bray")
plot_ordination(norm_DESEQ, ord.DESEQ, color = "Subject", shape = "Time_Collected") +
  geom_point(size=1)
```

```{r}
metadata_DESEQ <- as(sample_data(norm_DESEQ ), "data.frame")
adonis(phyloseq::distance(norm_DESEQ, method="bray") ~  Gender+Subject/Location+ Subject/Time_Week+Subject,
       data = metadata_DESEQ)
```




```{r}
library(ComplexHeatmap)
library(stringr)

DESEQ_Metadata_core_stat2<-DESEQ_Metadata_core_stat
DESEQ_Metadata_core_stat2 <-  subset(DESEQ_Metadata_core_stat2, select = c(Time_Collected, Subject, shannon.vegan))

DESEQ_Metadata_core_stat2$Time_Collected[which(DESEQ_Metadata_core_stat2$Time_Collected == "T_0")] <-"T1"
DESEQ_Metadata_core_stat2$Time_Collected[which(DESEQ_Metadata_core_stat2$Time_Collected == "2_week")] <-"T2"
DESEQ_Metadata_core_stat2$Time_Collected[which(DESEQ_Metadata_core_stat2$Time_Collected == "1_month")] <-"T3"
DESEQ_Metadata_core_stat2$Time_Collected[which(DESEQ_Metadata_core_stat2$Time_Collected == "3_month")] <-"T4"
DESEQ_Metadata_core_stat2$Time_Collected[which(DESEQ_Metadata_core_stat2$Time_Collected == "6_month")] <-"T5"
library(reshape2)
mat <- dcast(DESEQ_Metadata_core_stat2, Subject~Time_Collected, value.var="shannon.vegan")
rownames(mat) <- mat[,1]
mat[,1] <- NULL
mat<- as.matrix(mat)
Heatmap(mat, lgd = Legend(col_fun = col_fun, title = "foo", legend_height = unit(6, "cm")))
```

```{r}
alpha_meas = c("Observed", "Chao1", "Shannon")
(p <- plot_richness(ps_rarefy, "Location", measures=alpha_meas))
test <- (p + geom_boxplot(data=p$data, aes(x=Location, y=value, color=NULL), alpha=0.1)) 
plot(test)
observed_pairwise <- pairwise.wilcox.test(obser_rarefy$Observed, sample_data(ps_rarefy)$Location)
observed_pairwise
chao1_pairwise <- pairwise.wilcox.test(Chao1_obser_rarefy$Chao1, sample_data(ps_rarefy)$Location)
chao1_pairwise 
shannon_pairwise <- pairwise.wilcox.test(shannon_obser_rarefy$Shannon, sample_data(ps_rarefy)$Location)
shannon_pairwise
```

library(ComplexHeatmap)
library(stringr)

RH_Metadata_core_stat2<-RH_Metadata_core_stat
RH_Metadata_core_stat2 <-  subset(RH_Metadata_core_stat2, select = c(Time_Collected, Subject, shannon.vegan))

RH_Metadata_core_stat2$Time_Collected[which(RH_Metadata_core_stat2$Time_Collected == "T_0")] <-"T1"
RH_Metadata_core_stat2$Time_Collected[which(RH_Metadata_core_stat2$Time_Collected == "2_week")] <-"T2"
RH_Metadata_core_stat2$Time_Collected[which(RH_Metadata_core_stat2$Time_Collected == "1_month")] <-"T3"
RH_Metadata_core_stat2$Time_Collected[which(RH_Metadata_core_stat2$Time_Collected == "3_month")] <-"T4"
RH_Metadata_core_stat2$Time_Collected[which(RH_Metadata_core_stat2$Time_Collected == "6_month")] <-"T5"
library(reshape2)
mat <- dcast(RH_Metadata_core_stat2, Subject~Time_Collected, value.var="shannon.vegan")
rownames(mat) <- mat[,1]
mat[,1] <- NULL
mat<- as.matrix(mat)
Heatmap(mat)


res = results(diagdds, cooksCutoff = FALSE)
alpha = 0.01
sigtab = res[which(res$padj < alpha), ]
View(sigtab)
norm_merged_groups <- transform_sample_counts(core_total_merge , function(x) x / sum(x) )
sigtab2 <- prune_taxa(sigtab, norm_merged_groups )
#sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(core_total_merge)[rownames(sigtab), ], "matrix"))
head(sigtab)
```